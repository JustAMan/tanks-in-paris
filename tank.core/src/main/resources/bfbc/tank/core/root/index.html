<html>
<head>
	<script src="/js/tools.js"></script>

	<title>Tanks proto</title>
	<script>
		var cellSize = 22;
	
		// Preloading
		new Image().src = "img/tank_parts/tank-caterpillars-frame1.svg"; 
		new Image().src = "img/tank_parts/tank-caterpillars-frame2.svg"; 
		new Image().src = "img/tank_parts/tank-shadow.svg"; 
		new Image().src = "img/tank_parts/green/tank-caterpillars-frame1-overlay.svg"; 
		new Image().src = "img/tank_parts/green/tank-caterpillars-frame2-overlay.svg"; 
		new Image().src = "img/tank_parts/yellow/tank-caterpillars-frame1-overlay.svg"; 
		new Image().src = "img/tank_parts/yellow/tank-caterpillars-frame2-overlay.svg"; 
		new Image().src = "img/tank_parts/tank-full-body.svg"; 
		new Image().src = "img/tank_parts/green/tank-full-body-overlay.svg"; 
		new Image().src = "img/tank_parts/yellow/tank-full-body-overlay.svg"; 
		new Image().src = "img/concrete-full.svg"; 
		
		// Globals
		var websocket;
		var webSocketAddress;

		var fieldNode;
		var playersNode;
		var missilesNode;
		
		var firstUpdate = true;
		
		var skins = [ "yellow", "green" ]
		
		function init()
		{
			playersNode = document.getElementById("players");
			fieldNode = document.getElementById("field");
			missilesNode = document.getElementById("missiles");
		
			webSocketAddress = buildWebSocketAddress("player");
			openStatusSocket();
		}
		
		function updateTanks(gameStatePlayers) {
		
			if (firstUpdate) {
				// Removing all tanks
				while (playersNode.firstChild != null) {
					playersNode.removeChild(playersNode.firstChild);
				}
				
				for (var i = 0; i < gameStatePlayers.length; i++) {
	
					var playerTankShadowNode = document.createElement("div");
					playerTankShadowNode.setAttribute("id", "player" + (i+1) + "-tank-shadow");
					playerTankShadowNode.classList.add("tank-shadow");
					
					var playerTankCaterpillarsNode = document.createElement("div");
					playerTankCaterpillarsNode.setAttribute("id", "player" + (i+1) + "-tank-caterpillars");
					playerTankCaterpillarsNode.classList.add("tank-caterpillars");
	
					var playerTankCaterpillarsOverlayNode = document.createElement("div");
					playerTankCaterpillarsOverlayNode.setAttribute("id", "player" + (i+1) + "-tank-caterpillars-overlay");
					playerTankCaterpillarsOverlayNode.classList.add("tank-caterpillars-overlay");
					playerTankCaterpillarsOverlayNode.classList.add(skins[i]);
					
					var playerTankBodyNode = document.createElement("div");
					playerTankBodyNode.setAttribute("id", "player" + (i+1) + "-tank-body");
					playerTankBodyNode.classList.add("tank-body");
					
					var playerTankBodyOverlayNode = document.createElement("div");
					playerTankBodyOverlayNode.setAttribute("id", "player" + (i+1) + "-tank-overlay");
					playerTankBodyOverlayNode.classList.add("tank-body-overlay");
					playerTankBodyOverlayNode.classList.add(skins[i]);
					
					var playerTankNode = document.createElement("div");
					playerTankNode.setAttribute("id", "player" + (i+1) + "-tank");
					playerTankNode.classList.add("tank");
					
					playerTankNode.appendChild(playerTankShadowNode);
					playerTankNode.appendChild(playerTankCaterpillarsNode);
					playerTankNode.appendChild(playerTankCaterpillarsOverlayNode);
					playerTankNode.appendChild(playerTankBodyNode);
					playerTankNode.appendChild(playerTankBodyOverlayNode);
					
					playersNode.appendChild(playerTankNode);
					
					caterpillarInit(playerTankCaterpillarsNode);
					movementInit(playerTankNode);
	
				}
			}
			
			var playerTankNodeElements = playersNode.childNodes;
			for (var i = 0; i < playerTankNodeElements.length; i++) {
				var playerTankNode = document.getElementById("player" + (i+1) + "-tank");
				var playerCaterpillarsNode = document.getElementById("player" + (i+1) + "-tank-caterpillars");

				playerCaterpillarsNode.moving = gameStatePlayers[i].moving;
				playerTankNode.posX = gameStatePlayers[i].posX;
				playerTankNode.posY = gameStatePlayers[i].posY;
				playerTankNode.angle = gameStatePlayers[i].angle;
			}
			
		}
		
		function updateMissiles(missiles) {
			var recreateMissilesNode = false;
			if (missilesNode.childNodes.length != missiles.length) {
				recreateMissilesNode = true;
				// Removing all missiles for all players
				while (missilesNode.firstChild != null) {
					missilesNode.removeChild(missilesNode.firstChild);
				}
			}
			
			for (var i = 0; i < playersNode.childNodes.length; i++) {
				var playerMissilesNode;
				if (recreateMissilesNode) {
					playerMissilesNode = document.createElement("div");
					missilesNode.appendChild(playerMissilesNode);
				} else {
					playerMissilesNode = missilesNode.childNodes[i];
				}
				
				var recreatePlayerMissiles = false;
				if (playerMissilesNode.childNodes.length != missiles[i].length) {
					recreatePlayerMissiles = true;
					// Removing all missiles for player
					while (playerMissilesNode.firstChild != null) {
						playerMissilesNode.removeChild(playerMissilesNode.firstChild);
					}
				}
				
				for (var j = 0; j < missiles[i].length; j++) {
					if (recreatePlayerMissiles) {
						var missileNode = document.createElement("div");
						missileNode.classList.add("missile");
					} else {
						missileNode = playerMissilesNode.childNodes[j];
					}
					
					missileNode.posX = missiles[i][j].posX;
					missileNode.posY = missiles[i][j].posY;
					missileNode.angle = missiles[i][j].angle;

					playerMissilesNode.appendChild(missileNode);
				}

			}
		}
		
		function openStatusSocket() {
		    websocket = new WebSocket(webSocketAddress);
		    
		    websocket.onopen = function(evt) {
		    };
		    
		    websocket.onmessage = function(evt) {
		    	var gameState = JSON.parse(evt.data);

				updateTanks(gameState.players);
				
				for (var j = 0; j < gameState.fieldHeight; j++) {
					for (var i = 0; i < gameState.fieldWidth; i++) {
						var cell = document.cells[j * gameState.fieldWidth + i];
						
						cell.classList.remove("concrete");
						
						if (gameState.field[j * gameState.fieldWidth + i].type == "CONCRETE") {
							cell.classList.add("concrete");
						}
					}
				}

				// Missiles
				updateMissiles(gameState.missiles);
				
				if (firstUpdate) {
					window.setInterval(function() {
						window.frame ++;
						var playerTankNodeElements = playersNode.childNodes;
						for (var i = 0; i < playerTankNodeElements.length; i++) {
							var playerTankNode = document.getElementById("player" + (i+1) + "-tank");
							var playerTankCaterpillarsNode = document.getElementById("player" + (i+1) + "-tank-caterpillars");
							var playerTankCaterpillarsOverlayNode = document.getElementById("player" + (i+1) + "-tank-caterpillars-overlay");
							if (window.frame % 4 == 0) {
								caterpillarFrame(playerTankCaterpillarsNode, playerTankCaterpillarsOverlayNode);
							}
							movementFrame(playerTankNode);
						}
						
						var missilesNodeElements = missilesNode.childNodes;
						for (var i = 0; i < missilesNodeElements.length; i++) {
							
							for (var j = 0; j < missilesNodeElements[i].childNodes.length; j++) {
								movementFrame(missilesNodeElements[i].childNodes[j]);
							}
						}
						
					}, 15);
				}
				
				firstUpdate = false;
				
		    	//throw 'Invalid message from client: "' + evt.data + '"';
		    };
		    websocket.onerror = function(evt) {
		    };
		    websocket.onclose = function(evt) {
		    };
		}
	
		var fieldWidth = 29;
		var fieldHeight = 27;
	
		function fieldInit(fieldNode) {
			document.cells = [];
		
			fieldNode.style.width = (fieldWidth * cellSize) + "px";
			fieldNode.style.height = (fieldHeight * cellSize) + "px";
		
			for (var j = 0; j < fieldHeight; j++) {
				for (var i = 0; i < fieldWidth; i++) {
					var cell = document.createElement("div");
					cell.classList.add("field-cell");

					cell.style.left = (cellSize * i - 1.5) + "px";
					cell.style.top = (cellSize * j - 1.5) + "px";

					fieldNode.appendChild(cell);
					document.cells[j * fieldWidth + i] = cell;
				}
			}
		}
	
		function caterpillarInit(caterpillarNode) {
			caterpillarNode.caterpillarFrame = 0;
		}
		function caterpillarFrame(caterpillarNode, caterpillarOverlayNode) {
			if (caterpillarNode.moving) {
				caterpillarNode.caterpillarFrame = (caterpillarNode.caterpillarFrame + 1) % 2;
			}
			caterpillarNode.style.backgroundImage = "url('img/tank_parts/tank-caterpillars-frame" + (caterpillarNode.caterpillarFrame + 1) + ".svg')";
			caterpillarOverlayNode.style.backgroundImage = "url('img/tank_parts/' + caterpillarOverlayNode.skin + '/tank-caterpillars-frame" + (caterpillarNode.caterpillarFrame + 1) + "-overlay.svg')";
		}
		
		function movementInit(tankNode) {
			tankNode.posX = 20;
			tankNode.posY = 40;
			tankNode.angle = 0;
			tankNode.moving = false;
		}
					
		function movementFrame(tankNode) {
			tankNode.style.transform = "rotate(" + (tankNode.angle) + "deg)";
			tankNode.style.left = tankNode.posX + "px";
			tankNode.style.top = tankNode.posY + "px";

		}

		// Setting events
		
		window.addEventListener("load", function() {
			init();
			
			window.frame = 0;
			fieldInit(fieldNode);
			
		});
	
		var keysDown = {
			up: false,
			down: false,
			left: false,
			right: false,
			fire: false
		};

		function sendCommands() {
			websocket.send(JSON.stringify(keysDown));
		}
		
		window.addEventListener("keydown", function(e) {

			e = e || window.event;

			if (e.keyCode == '38') {
				// up arrow
				keysDown.up = true;
			}
			else if (e.keyCode == '40') {
				// down arrow
				keysDown.down = true;
			}
			else if (e.keyCode == '37') {
				// left arrow
				keysDown.left = true;
			}
			else if (e.keyCode == '39') {
				// right arrow
				keysDown.right = true;
			}
			else if (e.keyCode == '32') {
				// spacebar
				keysDown.fire = true;
			}
			
			sendCommands();
		});
		
		window.addEventListener("keyup", function(e) {

			e = e || window.event;

			if (e.keyCode == '38') {
				// up arrow
				keysDown.up = false;
			}
			else if (e.keyCode == '40') {
				// down arrow
				keysDown.down = false;
			}
			else if (e.keyCode == '37') {
				// left arrow
				keysDown.left = false;
			}
			else if (e.keyCode == '39') {
				// right arrow
				keysDown.right = false;
			}
			else if (e.keyCode == '32') {
				// spacebar
				keysDown.fire = false;
			}
			
			sendCommands();
		});

	</script>
	<style>
		body {
			margin: 0;
			background-color: black;
		}
	
		div.tank {
			position: absolute;
			left: 20px;
			top: 40px;
			width: 40px;
			height: 40px;
			background-repeat: no-repeat;
			background-size: 100% 100%;
		}
		
		div.tank-caterpillars {
			position: absolute; left: 0; top: 0;
			width: 40px;
			height: 40px;
			background-repeat: no-repeat;
			background-size: 100% 100%;
		}
		
		div.tank-caterpillars-overlay {
			position: absolute; left: 0; top: 0;
			width: 40px;
			height: 40px;
			background-repeat: no-repeat;
			background-size: 100% 100%;
			mix-blend-mode: multiply;
		}
		div.tank-caterpillars-overlay.green {
			background-image: url('img/tank_parts/green/tank-caterpillars-frame1-overlay.svg');
		}
		div.tank-caterpillars-overlay.yellow {
			background-image: url('img/tank_parts/yellow/tank-caterpillars-frame1-overlay.svg');
		}

		div.tank-body {
			position: absolute; left: 0; top: 0;
			width: 40px;
			height: 40px;
			background-repeat: no-repeat;
			background-size: 100% 100%;
			background-image: url('img/tank_parts/tank-full-body.svg');
		}

		div.tank-shadow {
			position: absolute; left: 0; top: 0;
			width: 40px;
			height: 40px;
			background-repeat: no-repeat;
			background-size: 100% 100%;
			background-image: url('img/tank_parts/tank-shadow.svg');
		}

		div.tank-body-overlay {
			position: absolute; left: 0; top: 0;
			width: 40px;
			height: 40px;
			background-repeat: no-repeat;
			background-size: 100% 100%;
			mix-blend-mode: multiply;
		}
		
		div.tank-body-overlay.green {
			background-image: url('img/tank_parts/green/tank-full-body-overlay.svg');
		}
		div.tank-body-overlay.yellow {
			background-image: url('img/tank_parts/yellow/tank-full-body-overlay.svg');
		}
		
		div.field-cell {
			position: absolute;
			width: 28px;
			height: 28px;
		}

		div.concrete {
			position: absolute; left: 0; top: 0;
			width: 28px;
			height: 28px;
			background-image: url('img/concrete-full.svg');
			background-repeat: no-repeat;
			background-size: 100% 100%;
		}
		
		div.field {
			margin: 0;
			background: linear-gradient(-170deg, #505850, #657065);
		}
		
		div.missile {
			position: absolute; left: 0; top: 0;
			width: 20px;
			height: 20px;
			background-repeat: no-repeat;
			background-size: 100% 100%;
			background-image: url('img/missile.svg');
		}
		
	</style>
</head>
<body>
	<!-- 28x26 -->
	<div id="field" class="field"></div>

	<div id="players"></div>
	<div id="missiles"></div>
</body>
</html>