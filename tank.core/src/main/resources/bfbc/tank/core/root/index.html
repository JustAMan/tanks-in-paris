<html>
<head>
	<link rel="stylesheet" type="text/css" href="main.css" />

	<script src="/js/tools.js"></script>

	<title>Tanks proto</title>
	
	<script>
	
		// Preloading
		new Image().src = "img/tank_parts/tank-caterpillars-frame1.svg"; 
		new Image().src = "img/tank_parts/tank-caterpillars-frame2.svg"; 
		new Image().src = "img/tank_parts/tank-shadow.svg"; 
		new Image().src = "img/tank_parts/green/tank-caterpillars-frame1-overlay.svg"; 
		new Image().src = "img/tank_parts/green/tank-caterpillars-frame2-overlay.svg"; 
		new Image().src = "img/tank_parts/yellow/tank-caterpillars-frame1-overlay.svg"; 
		new Image().src = "img/tank_parts/yellow/tank-caterpillars-frame2-overlay.svg"; 
		new Image().src = "img/tank_parts/tank-full-body.svg"; 
		new Image().src = "img/tank_parts/green/tank-full-body-overlay.svg"; 
		new Image().src = "img/tank_parts/yellow/tank-full-body-overlay.svg"; 
		new Image().src = "img/concrete-full.svg"; 
		
		// Globals
		var websocket;
		var webSocketAddress;
		var activePlayerIndex;

		var fieldNode;
		var playersNode;
		var missilesNode;
		var debugSvgNode;
		var cells = [];
		
		var firstUpdate = true;
		
		var skins = [ "yellow", "green" ]
		
		function updateTanks(players) {
		
			if (firstUpdate) {
				// Removing all tanks
				while (playersNode.firstChild != null) {
					playersNode.removeChild(playersNode.firstChild);
				}
				
				for (var i = 0; i < players.length; i++) {
	
					var playerTankShadowNode = document.createElement("div");
					playerTankShadowNode.setAttribute("id", "player" + (i+1) + "-tank-shadow");
					playerTankShadowNode.classList.add("tank-shadow");
					
					var playerTankCaterpillarsNode = document.createElement("div");
					playerTankCaterpillarsNode.setAttribute("id", "player" + (i+1) + "-tank-caterpillars");
					playerTankCaterpillarsNode.classList.add("tank-caterpillars");
					playerTankCaterpillarsNode.classList.add("frame1");

					var playerTankCaterpillarsOverlayNode = document.createElement("div");
					playerTankCaterpillarsOverlayNode.setAttribute("id", "player" + (i+1) + "-tank-caterpillars-overlay");
					playerTankCaterpillarsOverlayNode.classList.add("tank-caterpillars-overlay");
					playerTankCaterpillarsOverlayNode.classList.add(skins[i]);
					playerTankCaterpillarsOverlayNode.classList.add("frame1");
					
					var playerTankBodyNode = document.createElement("div");
					playerTankBodyNode.setAttribute("id", "player" + (i+1) + "-tank-body");
					playerTankBodyNode.classList.add("tank-body");
					
					var playerTankBodyOverlayNode = document.createElement("div");
					playerTankBodyOverlayNode.setAttribute("id", "player" + (i+1) + "-tank-overlay");
					playerTankBodyOverlayNode.classList.add("tank-body-overlay");
					playerTankBodyOverlayNode.classList.add(skins[i]);
					
					var playerTankNode = document.createElement("div");
					playerTankNode.setAttribute("id", "player" + (i+1) + "-tank");
					playerTankNode.classList.add("tank");
					
					playerTankNode.appendChild(playerTankShadowNode);
					playerTankNode.appendChild(playerTankCaterpillarsNode);
					playerTankNode.appendChild(playerTankCaterpillarsOverlayNode);
					playerTankNode.appendChild(playerTankBodyNode);
					playerTankNode.appendChild(playerTankBodyOverlayNode);
					
					playersNode.appendChild(playerTankNode);
					
					playerTankCaterpillarsNode.caterpillarFrame = 0;
				}
			}
			
			var playerTankNodeElements = playersNode.childNodes;
			for (var i = 0; i < playerTankNodeElements.length; i++) {
				var playerTankNode = document.getElementById("player" + (i+1) + "-tank");
				var playerCaterpillarsNode = document.getElementById("player" + (i+1) + "-tank-caterpillars");

				playerCaterpillarsNode.moving = players[i].moving;
				playerTankNode.posX = players[i].posX;
				playerTankNode.posY = players[i].posY;
				playerTankNode.angle = players[i].angle;
			}
			
		}
		
		function updateMissiles(missiles) {
			var recreateMissilesNode = false;
			if (missilesNode.childNodes.length != missiles.length) {
				recreateMissilesNode = true;
				// Removing all missiles for all players
				while (missilesNode.firstChild != null) {
					missilesNode.removeChild(missilesNode.firstChild);
				}
			}
			
			for (var i = 0; i < playersNode.childNodes.length; i++) {
				var playerMissilesNode;
				if (recreateMissilesNode) {
					playerMissilesNode = document.createElement("div");
					missilesNode.appendChild(playerMissilesNode);
				} else {
					playerMissilesNode = missilesNode.childNodes[i];
				}
				
				var recreatePlayerMissiles = false;
				if (playerMissilesNode.childNodes.length != missiles[i].length) {
					recreatePlayerMissiles = true;
					// Removing all missiles for player
					while (playerMissilesNode.firstChild != null) {
						playerMissilesNode.removeChild(playerMissilesNode.firstChild);
					}
				}
				
				for (var j = 0; j < missiles[i].length; j++) {
					if (recreatePlayerMissiles) {
						var missileNode = document.createElement("div");
						missileNode.classList.add("missile");
					} else {
						missileNode = playerMissilesNode.childNodes[j];
					}
					
					missileNode.posX = missiles[i][j].posX;
					missileNode.posY = missiles[i][j].posY;
					missileNode.angle = missiles[i][j].angle;

					playerMissilesNode.appendChild(missileNode);
				}

			}
		}
		
		function updateScore(frags) {
			for (var i = 0; i < frags.length; i++) {
				var playerFragsNode = document.getElementById("player" + (i+1) + "-frags");
				playerFragsNode.innerHTML = frags[i];
			}
		}
		
		function openStatusSocket() {
		    websocket = new WebSocket(webSocketAddress);
		    
		    websocket.onopen = function(evt) {
		    };
		    
		    websocket.onmessage = function(evt) {
		    	var state = JSON.parse(evt.data);
		    	var gameState = state.game;
		    	

				// Active player index
				activePlayerIndex = state.activePlayerIndex;

				// Players
				updateTanks(gameState.players);

				// Field
				updateField(gameState);

				// Missiles
				updateMissiles(gameState.missiles);
				
				// Score
				updateScore(gameState.frags);
				
				// Debug SVG
				
				debugSvgNode.innerHTML = "";
				for (var i = 0; i < playersNode.childNodes.length; i++) {
					if (gameState.debugData[i] != null) {
						debugSvgNode.innerHTML += gameState.debugData[i].svg;
					}
				}
				
				if (firstUpdate) {
					window.frame = 0;
					window.setInterval(function() {
						window.frame ++;
						var playerTankNodeElements = playersNode.childNodes;
						for (var i = 0; i < playerTankNodeElements.length; i++) {
							var playerTankNode = document.getElementById("player" + (i+1) + "-tank");
							var playerTankCaterpillarsNode = document.getElementById("player" + (i+1) + "-tank-caterpillars");
							var playerTankCaterpillarsOverlayNode = document.getElementById("player" + (i+1) + "-tank-caterpillars-overlay");
							if (window.frame % 4 == 0) {
								caterpillarFrame(playerTankCaterpillarsNode, playerTankCaterpillarsOverlayNode);
							}
							movementFrame(playerTankNode);
						}
						
						var missilesNodeElements = missilesNode.childNodes;
						for (var i = 0; i < missilesNodeElements.length; i++) {
							
							for (var j = 0; j < missilesNodeElements[i].childNodes.length; j++) {
								movementFrame(missilesNodeElements[i].childNodes[j]);
							}
						}
						
					}, 15);
				}
				
				firstUpdate = false;
				
		    	//throw 'Invalid message from client: "' + evt.data + '"';
		    };
		    websocket.onerror = function(evt) {
		    };
		    websocket.onclose = function(evt) {
		    };
		}
	
		function updateField(gameState) {
			
			if (firstUpdate) {
				cells = [];
			
				fieldNode.style.width = (gameState.fieldWidth * gameState.cellSize) + "px";
				fieldNode.style.height = (gameState.fieldHeight * gameState.cellSize) + "px";
			
				for (var j = 0; j < gameState.fieldHeight; j++) {
					for (var i = 0; i < gameState.fieldWidth; i++) {
						var cell = document.createElement("div");
						cell.classList.add("field-cell");
						fieldNode.appendChild(cell);
	
						var blockWidth = cell.clientWidth;
						var blockHeight = cell.clientHeight;
						cell.style.left = (gameState.cellSize * i - blockWidth / 2) + "px";
						cell.style.top = (gameState.cellSize * j - blockHeight / 2) + "px";
	
						cells[j * gameState.fieldWidth + i] = cell;
					}
				}
			}
			
			for (var j = 0; j < gameState.fieldHeight; j++) {
				for (var i = 0; i < gameState.fieldWidth; i++) {
					var cell = cells[j * gameState.fieldWidth + i];
					
					if (gameState.field[j * gameState.fieldWidth + i].type == "CONCRETE") {
						cell.classList.add("concrete");
					} else {
						cell.classList.remove("concrete");
					}
				}
			}
			
		}
		
		function caterpillarFrame(caterpillarNode, caterpillarOverlayNode) {
			if (caterpillarNode.moving) {
				caterpillarNode.classList.remove("frame" + (caterpillarNode.caterpillarFrame+1));
				caterpillarOverlayNode.classList.remove("frame" + (caterpillarNode.caterpillarFrame+1));

				caterpillarNode.caterpillarFrame = (caterpillarNode.caterpillarFrame + 1) % 2;

				caterpillarNode.classList.add("frame" + (caterpillarNode.caterpillarFrame+1));
				caterpillarOverlayNode.classList.add("frame" + (caterpillarNode.caterpillarFrame+1));
			}
		}
					
		function movementFrame(tankNode) {
			tankNode.style.transform = "rotate(" + (tankNode.angle) + "deg)";
			//tankNode.style.left = tankNode.posX + "px";
			//tankNode.style.top = tankNode.posY + "px";
			
			tankNode.style.left = (tankNode.posX - tankNode.clientWidth / 2) + "px";
			tankNode.style.top = (tankNode.posY - tankNode.clientHeight / 2) + "px";
		}

		// Setting events
		
		window.addEventListener("load", function() {
			playersNode = document.getElementById("players");
			fieldNode = document.getElementById("field");
			missilesNode = document.getElementById("missiles");
			debugSvgNode = document.getElementById("debug-svg");
		
			webSocketAddress = buildWebSocketAddress("player");
			openStatusSocket();
		});
	
		var keysDown = {
			up: false,
			down: false,
			left: false,
			right: false,
			fire: false
		};

		function sendCommands() {
			var clientState = {};
			clientState.keys = keysDown;
			
			// <DEMO> Demonstrating debug SVG feature. Remove this ASAP
			if (activePlayerIndex > -1) {
				clientState.debugData = {};
				clientState.debugData.svg = `
					<?xml version="1.0" encoding="utf-8"?>
					<!DOCTYPE svg PUBLIC 
					        "-//W3C//DTD SVG 1.1//EN" 
					        "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
					<svg style="opacity: 0.2; position: absolute; ` + 'left: ' + playersNode.childNodes[activePlayerIndex].posX + 'px; top: ' + playersNode.childNodes[activePlayerIndex].posY + 'px' + `" version="1.1" 
					        id="Layer_1" 
					        xmlns="http://www.w3.org/2000/svg" 
					        xmlns:xlink="http://www.w3.org/1999/xlink" width="80px" height="60px" 
					        viewBox="0 0 800 600" 
					        enable-background="new 0 0 800 600" 
					        xml:space="preserve">
					
					    <!-- face -->
					    <circle fill="#FFFF00" 
					            stroke="#000000" 
					            stroke-width="10" 
					            stroke-miterlimit="10" 
					            cx="382.553" 
					            cy="306.786" 
					            r="217.961"/>
					
					    <!-- mouth -->
					    <path fill="#FFFF00"
					            stroke="#000000"
					            stroke-width="10"
					            stroke-miterlimit="10"
					            d="M244.689,329.602 C315.563,498.534,484.495,479.116,531.583,333"/>
					
					    <!-- eyes -->
					    <ellipse
					            cx="337.592"
					            cy="233.485"
					            rx="21.359"
					            ry="49.272"/>
					    <ellipse
					            cx="422.592"
					            cy="232.485"
					            rx="21.359"
					            ry="49.272"/>
					</svg>
				`;
			}
			// </DEMO>
			
			websocket.send(JSON.stringify(clientState));
		}
		
		window.addEventListener("keydown", function(e) {

			e = e || window.event;

			if (e.keyCode == '38') {
				// up arrow
				keysDown.up = true;
			}
			else if (e.keyCode == '40') {
				// down arrow
				keysDown.down = true;
			}
			else if (e.keyCode == '37') {
				// left arrow
				keysDown.left = true;
			}
			else if (e.keyCode == '39') {
				// right arrow
				keysDown.right = true;
			}
			else if (e.keyCode == '32') {
				// spacebar
				keysDown.fire = true;
			}
			
			sendCommands();
		});
		
		window.addEventListener("keyup", function(e) {

			e = e || window.event;

			if (e.keyCode == '38') {
				// up arrow
				keysDown.up = false;
			}
			else if (e.keyCode == '40') {
				// down arrow
				keysDown.down = false;
			}
			else if (e.keyCode == '37') {
				// left arrow
				keysDown.left = false;
			}
			else if (e.keyCode == '39') {
				// right arrow
				keysDown.right = false;
			}
			else if (e.keyCode == '32') {
				// spacebar
				keysDown.fire = false;
			}
			
			sendCommands();
		});

	</script>
</head>

<body>
	
	<div class="root">
		<div class="game">
			<div id="players"></div>
			<div id="missiles"></div>
			<div id="field" class="field"></div>
			<div id="debug-svg" style="position: absolute; left: 0; top: 0;"></div>
		</div>
		<div class="frags-pane">
			<h2>Frags</h2>
			<div class="frags-player">
				Player 1: <span id="player1-frags">0</span>
			</div>
			<div class="frags-player">
				Player 2: <span id="player2-frags">0</span>
			</div>
		</div>
	</div>
</body>
</html>